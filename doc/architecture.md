# Flare IM Server 架构说明文档

## 1. 系统架构概述

Flare IM Server 采用微服务架构，主要分为以下几层：

- SDK 层：提供客户端接入能力
- 负载均衡层：提供服务负载均衡
- 网关层：提供接入和消息路由能力
- 微服务层：提供核心业务能力
- 中间件层：提供基础服务支持
- 存储层：提供数据持久化能力
- 基础设施层：提供运维和监控能力

## 2. 核心服务模块说明

### 2.1 网关服务

#### 2.1.1 API Gateway
- 职责：
  - 提供 HTTP/REST/gRPC 接口
  - 请求路由和负载均衡
  - 协议转换
  - 认证和鉴权
- 依赖：
  - Auth Service：认证授权
  - User Service：用户信息验证
  - Nginx：负载均衡

#### 2.1.2 Message Gateway
- 职责：
  - 维护长连接（WebSocket/QUIC）
  - 消息接收和推送
  - 心跳检测
  - 连接状态管理
- 依赖：
  - Message Router Service：消息路由
  - Session Service：会话管理
  - HAProxy：负载均衡

### 2.2 核心业务服务

#### 2.2.1 Message Router Service（消息路由服务）
- 职责：
  - 上行消息路由转发
  - 下行消息分发
  - 消息 QoS 保证
  - 消息优先级处理
  - 消息过滤规则
  - 业务系统对接
  - 负载均衡策略
- 依赖：
  - Message Store Service：消息存储
  - Message Filter Service：消息过滤
  - Session Service：会话管理
  - Redis：路由表缓存

#### 2.2.2 Session Service（会话服务）
- 职责：
  - 连接状态维护
  - 路由表更新
  - 会话保活
  - 心跳检测
  - 断线重连处理
  - 历史会话存储和同步
    * 存储用户所有历史会话列表
    * 会话基本信息（会话类型、名称、头像等）
    * 会话成员信息
    * 会话最新消息
    * 未读消息计数
    * 会话设置（免打扰、置顶等）
  - 多端会话同步
  - 会话恢复机制
    * 设备切换时快速恢复历史会话
    * 增量同步最新消息
  - 会话负载均衡
  - 异常会话清理
  - 会话监控告警
- 依赖：
  - Redis：会话状态存储
  - ClickHouse：历史会话存储

#### 2.2.3 Message Store Service（消息存储服务）
- 职责：
  - 消息持久化
  - 写入消息队列
  - 存储到列式存储
  - 消息去重
  - 数据压缩
  - 分片存储
  - 高性能查询支持
  - 实时分析能力
- 依赖：
  - Kafka：消息队列
  - ClickHouse：消息存储
  - Redis：消息缓存

#### 2.2.4 Message Filter Service（消息过滤服务）
- 职责：
  - 内容审核
  - 反垃圾处理
  - 敏感词过滤
  - 媒体审核
  - 规则管理
  - 过滤策略配置
- 依赖：
  - Redis：过滤规则缓存
  - PostgreSQL：规则存储

#### 2.2.5 Notification Service（通知服务）
- 职责：
  - 离线消息推送
  - 设备通知管理
  - 推送状态跟踪
  - 多平台推送集成
  - 推送模板管理
  - 推送频率控制
  - 通知分类管理
  - 推送统计分析
- 依赖：
  - Kafka：推送队列
  - Redis：设备信息缓存

#### 2.2.6 Message Sync Service（消息同步服务）
- 职责：
  - 多端消息同步
    * 增量同步策略
    * 全量同步策略
    * 实时同步机制
    * 离线消息同步
    * 消息状态同步
  - 序列号管理
    * 全局消息序列号生成
    * 会话内消息序列号管理
    * 序列号一致性保证
    * 序列号冲突解决
  - 消息操作同步
    * 消息撤回
    * 消息删除
    * 消息编辑
    * 消息引用
    * 消息回复
  - 状态同步
    * 已读状态同步
    * 送达状态同步
    * 在线状态同步
    * 输入状态同步
  - 冲突处理
    * 并发操作冲突解决
    * 多端状态一致性
    * 网络异常恢复
    * 数据版本管理
  - 同步优化
    * 批量同步
    * 压缩传输
    * 增量更新
    * 优先级控制
    * 带宽控制
- 依赖：
  - Message Store Service：消息存储
  - Session Service：会话管理
  - Redis：状态缓存和序列号管理
  - Kafka：操作事件队列

### 2.3 消息同步机制

#### 2.3.1 多端消息同步流程
1. 客户端连接建立后，向 Message Sync Service 请求同步
2. Message Sync Service 获取客户端最新同步点（序列号）
3. 根据同步策略执行同步：
   - 增量同步：获取序列号之后的新消息
   - 全量同步：获取完整的会话和消息历史
   - 快速同步：仅同步最近的活跃会话
4. 同步过程包含：
   - 消息内容
   - 消息状态（已读、已删除等）
   - 会话状态
   - 用户在线状态

#### 2.3.2 消息操作同步流程
1. 用户执行消息操作（撤回、删除等）
2. Message Gateway 将操作请求转发给 Message Sync Service
3. Message Sync Service 处理操作：
   - 验证操作权限
   - 生成操作序列号
   - 更新消息状态
   - 写入操作日志
4. 通过 Kafka 广播操作事件
5. 其他端收到同步通知：
   - 更新本地消息状态
   - 更新界面显示
   - 发送确认回执

#### 2.3.3 序列号管理机制
1. 全局序列号：
   - 使用 Redis 自增序列保证全局唯一
   - 按会话分片减少冲突
   - 支持批量分配提高效率
2. 会话序列号：
   - 每个会话独立序列号空间
   - 严格递增保证顺序
   - 支持多端并发写入
3. 冲突处理：
   - 使用向量时钟检测冲突
   - 基于时间戳和优先级解决冲突
   - 保留操作历史支持回滚

#### 2.3.4 消息同步流程图
```
┌──────────┐     ┌───────────────┐     ┌────────────────┐
│  Client  │     │Message Gateway│     │Message Sync    │
└────┬─────┘     └───────┬───────┘     └───────┬────────┘
     │                   │                      │
     │   1.同步请求      │                      │
     │─────────────────>│   2.转发请求         │
     │                   │─────────────────────>│
     │                   │                      │
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Store Service │
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Session Service
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │     3.同步响应       │    
     │                   │<─────────────────────│    
     │   4.增量数据      │                      │    
     │<──────────────────│                      │    
     │                   │                      │    
     │   5.状态更新      │                      │    
     │─────────────────>│   6.广播更新         │    
     │                   │─────────────────────>│    
     │                   │                      │    
     │                   │     7.其他端同步     │    
     │<──────────────────│<─────────────────────│    
```

### 2.4 可靠性保证

#### 2.4.1 同步可靠性
1. 序列号机制：
   - 严格递增保证顺序
   - 支持检测丢失和重复
   - 支持并发冲突检测
2. 状态一致性：
   - 定期状态校验
   - 增量对账机制
   - 全量恢复能力
3. 操作幂等性：
   - 操作ID去重
   - 状态机控制
   - 版本号管理

#### 2.4.2 性能优化
1. 同步策略：
   - 增量优先
   - 批量处理
   - 压缩传输
2. 缓存机制：
   - 多级缓存
   - 预加载优化
   - 淘汰策略
3. 限流控制：
   - 客户端限流
   - 服务端限流
   - 带宽控制

## 3. 消息流转流程

### 3.1 长连接建立流程
1. 客户端通过 API Gateway 获取可用的 Message Gateway
2. 客户端与 Message Gateway 建立 WebSocket 连接
3. Message Gateway 向 Session Service 注册连接
4. Session Service 更新 Redis 中的路由表

### 3.2 消息发送流程

#### 3.2.1 在线消息发送流程
1. 发送方发送消息到 Message Gateway
2. Message Gateway 将消息转发给 Message Router Service
3. Message Router Service 请求 Message Filter Service 进行内容过滤
   - 敏感词过滤
   - 反垃圾检测
   - 内容安全扫描
4. Message Router Service 将消息发送给 Message Store Service 进行存储
5. Message Store Service 处理消息：
   - 生成全局唯一消息ID
   - 设置消息时间戳
   - 写入 Kafka 消息队列
   - 异步写入 ClickHouse 持久化存储
6. Message Router Service 查询 Session Service 获取接收方在线状态
7. 如果接收方在线：
   - Message Router Service 查询 Redis 获取接收方路由信息
   - Message Router Service 将消息转发给目标 Message Gateway
   - Message Gateway 将消息推送给接收方
   - 接收方返回 ACK 确认
8. 如果接收方不在线：
   - Message Router Service 触发离线消息处理流程
   - 更新会话未读计数
   - 发送离线推送通知

#### 3.2.2 离线消息处理流程
1. Message Router Service 将未送达消息写入 Kafka 离线消息队列
2. Message Store Service 消费消息并处理：
   - 将消息存储到 ClickHouse
   - 更新会话最新消息
   - 更新未读消息计数
3. 触发 Notification Service 进行推送：
   - 获取接收方设备推送令牌
   - 根据消息类型选择推送模板
   - 生成推送内容
4. Notification Service 通过推送通道（APNS/FCM等）发送通知
5. 当用户在线时：
   - Session Service 检测到用户上线
   - 触发离线消息同步
   - 批量拉取未读消息
   - 更新会话状态

#### 3.2.3 消息流转流程图
```
┌──────────┐     ┌───────────────┐     ┌────────────────┐
│  Client  │     │Message Gateway│     │Message Router  │
└────┬─────┘     └───────┬───────┘     └───────┬────────┘
     │                   │                      │
     │   1.发送消息      │                      │
     │─────────────────>│   2.转发消息         │
     │                   │─────────────────────>│
     │                   │                      │
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Filter Service│
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Store Service │
     │                   │                      │    └──────┬──────┘
     │                   │                      │           │
     │                   │                      │           │ 
     │                   │                      │    ┌──────┴──────┐
     │                   │                      │    │   Kafka     │
     │                   │                      │    └──────┬──────┘
     │                   │                      │           │
     │                   │                      │    ┌──────┴──────┐
     │                   │                      │    │ ClickHouse  │
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Session Service
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │         在线          │    
     │                   │<─────────────────────│    
     │   推送消息        │                      │    
     │<──────────────────│                      │    
     │                   │                      │    
     │                   │        离线          │    ┌─────────────┐
     │                   │                      │───>│Notification  │
     │                   │                      │    │  Service    │
     │   推送通知        │                      │    └─────────────┘
     │<───────────────────────────────────────────────────────────┘
     │                   │                      │
```

## 4. 可靠性保证机制

### 4.1 消息可靠性
1. ACK 确认机制：消息发送方收到接收方的确认后才认为发送成功
2. 消息重试机制：未收到 ACK 的消息会进行指数退避重试
3. 幂等性处理：通过消息 ID 去重，确保消息不会重复处理
4. 持久化保证：消息写入 Kafka 后再返回发送成功
5. 分布式事务：采用最终一致性确保消息状态同步

### 4.2 存储可靠性
1. 分片存储：按时间和会话 ID 进行分片存储
2. 冷热分离：热数据保存在 ClickHouse，冷数据迁移到对象存储
3. 数据压缩：利用 ClickHouse 高效列式压缩，支持快速检索
4. 分级存储：
   - L0：Redis 缓存最近消息
   - L1：ClickHouse 存储活跃消息（支持实时分析）
   - L2：对象存储归档历史消息

## 5. 异步处理机制

### 5.1 消息存储异步化
- 消息先进入 Kafka 队列
- Store Service 异步消费并持久化
- 支持批量写入优化

### 5.2 通知服务异步化
- 离线消息进入通知队列
- Notification Service 异步处理推送
- 支持推送限流和重试

## 6. 服务依赖关系

### 6.1 核心依赖链
- Message Gateway -> Message Router
- Message Router -> Message Store
- Message Router -> Message Filter
- Message Router -> Session Service
- Message Store -> Kafka
- Session Service -> Redis
- Notification Service -> Redis

### 6.2 存储依赖
- 消息存储：ClickHouse
- 用户数据：PostgreSQL
- 媒体文件：MinIO
- 缓存数据：Redis Cluster
- 配置中心：etcd

## 7. 监控和运维

### 7.1 系统监控
- Prometheus：指标收集
- Grafana：监控可视化
- ELK Stack：日志分析
- Jaeger：分布式追踪

### 7.2 安全保障
- WAF：Web 应用防火墙
- DDoS 防护
- 数据加密传输
- 访问控制策略 