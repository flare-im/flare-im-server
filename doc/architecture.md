# Flare IM Server 架构说明文档

## 1. 系统架构概述

Flare IM Server 采用微服务架构，主要分为以下几层：

- SDK 层：提供客户端接入能力
- 负载均衡层：提供服务负载均衡
- 网关层：提供接入和消息路由能力
- 微服务层：提供核心业务能力
- 中间件层：提供基础服务支持
- 存储层：提供数据持久化能力
- 基础设施层：提供运维和监控能力

## 2. 核心服务模块说明

### 2.1 网关服务

#### 2.1.1 API Gateway
- 职责：
  - 提供 HTTP/REST/gRPC 接口
  - 请求路由和负载均衡
  - 协议转换
  - 认证和鉴权
- 依赖：
  - Auth Service：认证授权
  - User Service：用户信息验证
  - Nginx：负载均衡

#### 2.1.2 Message Gateway
- 职责：
  - 维护长连接（WebSocket/QUIC）
  - 消息接收和推送
  - 心跳检测
  - 连接状态管理
- 依赖：
  - Message Router Service：消息路由
  - Session Service：会话管理
  - HAProxy：负载均衡

### 2.2 核心业务服务

#### 2.2.1 Message Router Service（消息路由服务）
- 职责：
  - 上行消息路由转发
  - 下行消息分发
  - 消息 QoS 保证
  - 消息优先级处理
  - 消息过滤规则
  - 业务系统对接
  - 负载均衡策略
- 依赖：
  - Message Store Service：消息存储
  - Message Filter Service：消息过滤
  - Session Service：会话管理
  - Redis：路由表缓存

#### 2.2.2 Session Service（会话服务）
- 职责：
  - 连接状态维护
  - 路由表更新
  - 会话保活
  - 心跳检测
  - 断线重连处理
  - 历史会话存储和同步
    * 存储用户所有历史会话列表
    * 会话基本信息（会话类型、名称、头像等）
    * 会话成员信息
    * 会话最新消息
    * 未读消息计数
    * 会话设置（免打扰、置顶等）
  - 多端会话同步
  - 会话恢复机制
    * 设备切换时快速恢复历史会话
    * 增量同步最新消息
  - 会话负载均衡
  - 异常会话清理
  - 会话监控告警
- 依赖：
  - Redis：会话状态存储
  - ClickHouse：历史会话存储

#### 2.2.3 Message Store Service（消息存储服务）
- 职责：
  - 消息持久化
  - 写入消息队列
  - 存储到列式存储
  - 消息去重
  - 数据压缩
  - 分片存储
  - 高性能查询支持
  - 实时分析能力
- 依赖：
  - Kafka：消息队列
  - ClickHouse：消息存储
  - Redis：消息缓存

#### 2.2.4 Message Filter Service（消息过滤服务）
- 职责：
  - 内容审核
  - 反垃圾处理
  - 敏感词过滤
  - 媒体审核
  - 规则管理
  - 过滤策略配置
- 依赖：
  - Redis：过滤规则缓存
  - PostgreSQL：规则存储

#### 2.2.5 Notification Service（通知服务）
- 职责：
  - 离线消息推送
  - 设备通知管理
  - 推送状态跟踪
  - 多平台推送集成
  - 推送模板管理
  - 推送频率控制
  - 通知分类管理
  - 推送统计分析
- 依赖：
  - Kafka：推送队列
  - Redis：设备信息缓存

#### 2.2.6 Message Sync Service（消息同步服务）
- 职责：
  - 多端消息同步
    * 增量同步策略
    * 全量同步策略
    * 实时同步机制
    * 离线消息同步
    * 消息状态同步
  - 序列号管理
    * 全局消息序列号生成
    * 会话内消息序列号管理
    * 序列号一致性保证
    * 序列号冲突解决
  - 消息操作同步
    * 消息撤回
    * 消息删除
    * 消息编辑
    * 消息引用
    * 消息回复
  - 状态同步
    * 已读状态同步
    * 送达状态同步
    * 在线状态同步
    * 输入状态同步
  - 冲突处理
    * 并发操作冲突解决
    * 多端状态一致性
    * 网络异常恢复
    * 数据版本管理
  - 同步优化
    * 批量同步
    * 压缩传输
    * 增量更新
    * 优先级控制
    * 带宽控制
- 依赖：
  - Message Store Service：消息存储
  - Session Service：会话管理
  - Redis：状态缓存和序列号管理
  - Kafka：操作事件队列

### 2.3 消息同步机制

#### 2.3.1 多端消息同步流程
1. 客户端连接建立后，向 Message Sync Service 请求同步
2. Message Sync Service 获取客户端最新同步点（序列号）
3. 根据同步策略执行同步：
   - 增量同步：获取序列号之后的新消息
   - 全量同步：获取完整的会话和消息历史
   - 快速同步：仅同步最近的活跃会话
4. 同步过程包含：
   - 消息内容
   - 消息状态（已读、已删除等）
   - 会话状态
   - 用户在线状态

#### 2.3.2 消息操作同步流程
1. 用户执行消息操作（撤回、删除等）
2. Message Gateway 将操作请求转发给 Message Sync Service
3. Message Sync Service 处理操作：
   - 验证操作权限
   - 生成操作序列号
   - 更新消息状态
   - 写入操作日志
4. 通过 Kafka 广播操作事件
5. 其他端收到同步通知：
   - 更新本地消息状态
   - 更新界面显示
   - 发送确认回执

#### 2.3.3 序列号管理机制
1. 全局序列号：
   - 使用 Redis 自增序列保证全局唯一
   - 按会话分片减少冲突
   - 支持批量分配提高效率
2. 会话序列号：
   - 每个会话独立序列号空间
   - 严格递增保证顺序
   - 支持多端并发写入
3. 冲突处理：
   - 使用向量时钟检测冲突
   - 基于时间戳和优先级解决冲突
   - 保留操作历史支持回滚

#### 2.3.4 消息同步流程图
```
┌──────────┐     ┌───────────────┐     ┌────────────────┐
│  Client  │     │Message Gateway│     │Message Sync    │
└────┬─────┘     └───────┬───────┘     └───────┬────────┘
     │                   │                      │
     │   1.同步请求      │                      │
     │─────────────────>│   2.转发请求         │
     │                   │─────────────────────>│
     │                   │                      │
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Store Service │
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │                      │    ┌─────────────┐
     │                   │                      │───>│Session Service
     │                   │                      │    └─────────────┘
     │                   │                      │    
     │                   │     3.同步响应       │    
     │                   │<─────────────────────│    
     │   4.增量数据      │                      │    
     │<──────────────────│                      │    
     │                   │                      │    
     │   5.状态更新      │                      │    
     │─────────────────>│   6.广播更新         │    
     │                   │─────────────────────>│    
     │                   │                      │    
     │                   │     7.其他端同步     │    
     │<──────────────────│<─────────────────────│    
```

### 2.4 可靠性保证

#### 2.4.1 同步可靠性
1. 序列号机制：
   - 严格递增保证顺序
   - 支持检测丢失和重复
   - 支持并发冲突检测
2. 状态一致性：
   - 定期状态校验
   - 增量对账机制
   - 全量恢复能力
3. 操作幂等性：
   - 操作ID去重
   - 状态机控制
   - 版本号管理

#### 2.4.2 性能优化
1. 同步策略：
   - 增量优先
   - 批量处理
   - 压缩传输
2. 缓存机制：
   - 多级缓存
   - 预加载优化
   - 淘汰策略
3. 限流控制：
   - 客户端限流
   - 服务端限流
   - 带宽控制

## 3. 消息流转流程

### 3.1 长连接建立流程
1. 客户端通过 API Gateway 获取可用的 Message Gateway
2. 客户端与 Message Gateway 建立 WebSocket 连接
3. Message Gateway 向 Session Service 注册连接
4. Session Service 更新 Redis 中的路由表

### 3.2 消息发送流程

#### 3.2.1 消息处理流程概述

消息处理采用多级校验和异步处理机制，主要分为以下阶段：

1. 消息预处理和校验阶段
   - 基础格式校验
   - 敏感词过滤
   - 权限校验
   - 业务规则校验

2. 消息路由阶段
   - 消息分发策略
   - 在线状态判断
   - 离线消息处理

3. 消息存储阶段
   - 实时消息队列
   - 持久化存储
   - 消息同步

4. 消息投递阶段
   - 实时推送
   - 离线通知
   - 多端同步

#### 3.2.2 详细处理流程

1. 消息校验流程
   a. 基础校验
      - 消息格式验证
      - 必要字段检查
      - 消息大小限制
   
   b. 内容安全校验
      - 敏感词过滤
      - 反垃圾检测
      - 内容安全扫描
   
   c. 权限校验
      - 发送方权限检查
      - 群成员状态检查
      - 好友关系验证
      - 黑名单检查
   
   d. 业务规则校验
      - 消息频率限制
      - 会话状态检查
      - 用户状态验证

2. 消息路由流程
   a. 路由策略
      - 单聊消息路由
      - 群聊消息路由
      - 系统消息路由
   
   b. 在线状态处理
      - 在线用户直接投递
      - 离线用户消息缓存
      - 多端状态同步
   
   c. 消息分发
      - 实时消息推送
      - 离线消息存储
      - 多端消息同步

3. 存储流程
   a. 消息队列
      - 实时消息队列（Kafka）
      - 离线消息队列
      - 通知消息队列
   
   b. 持久化存储
      - 消息内容存储（MongoDB）
      - 消息索引构建
      - 历史记录归档
   
   c. 缓存处理
      - 最近消息缓存
      - 会话状态缓存
      - 路由表缓存

#### 3.2.3 消息处理流程图

```
┌──────────┐     ┌───────────────┐     ┌────────────────┐     ┌────────────────┐
│  Client  │     │Message Gateway│     │Message Router  │     │Message Filter  │
└────┬─────┘     └───────┬───────┘     └───────┬────────┘     └───────┬────────┘
     │                   │                      │                      │
     │   1.发送消息      │                      │                      │
     │─────────────────>│                      │                      │
     │                   │                      │                      │
     │                   │   2.消息预处理       │                      │
     │                   │──────────────────────┤                      │
     │                   │                      │                      │
     │                   │                      │   3.内容过滤         │
     │                   │                      │─────────────────────>│
     │                   │                      │                      │
     │                   │                      │<─────────────────────│
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│Friend Service│  │
     │                   │                      │    └─────────────┘  │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│Group Service│  │
     │                   │                      │    └─────────────┘  │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│Rate Limiter │  │
     │                   │                      │    └─────────────┘  │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│   MQ-1      │  │
     │                   │                      │    │(消息可靠性) │  │
     │                   │                      │    └─────┬───────┘  │
     │                   │                      │          │          │
     │                   │                      │<─────────┘          │
     │   4.校验结果      │                      │                      │
     │<──────────────────│<─────────────────────│                      │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│Session Service  │
     │                   │                      │    └─────────────┘  │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│   MQ-2      │  │
     │                   │                      │    │(消息存储)   │  │
     │                   │                      │    └──────┬──────┘  │
     │                   │                      │           │         │
     │                   │                      │    ┌──────┴──────┐  │
     │                   │                      │    │Store Service│  │
     │                   │                      │    └──────┬──────┘  │
     │                   │                      │           │         │
     │                   │                      │    ┌──────┴──────┐  │
     │                   │                      │    │  MongoDB    │  │
     │                   │                      │    └─────────────┘  │
     │                   │                      │                      │
     │   5.消息投递      │                      │                      │
     │<──────────────────│<─────────────────────│                      │
     │                   │                      │                      │
     │                   │                      │    ┌─────────────┐  │
     │                   │                      │───>│   MQ-3      │  │
     │                   │                      │    │(离线通知)   │  │
     │                   │                      │    └──────┬──────┘  │
     │                   │                      │           │         │
     │                   │                      │    ┌──────┴──────┐  │
     │                   │                      │    │Notification │  │
     │                   │                      │    │  Service    │  │
     │                   │                      │    └──────┬──────┘  │
     │                   │                      │           │         │
     │   6.离线推送      │                      │           │         │
     │<────────────────────────────────────────────────────┘         │
```

#### 3.2.4 消息队列流转说明

1. MQ-1（消息可靠性队列）
   - 来源：Message Router 校验通过的消息
   - 去处：回到 Message Router 进行消息路由
   - 作用：确保消息不丢失，支持重试机制
   - 流程：
     * Router 将校验通过的消息写入 MQ-1
     * MQ-1 返回确认给 Router
     * Router 从 MQ-1 消费消息进行后续处理

2. MQ-2（消息存储队列）
   - 来源：Message Router 处理后的消息
   - 去处：Store Service 进行持久化
   - 作用：异步存储，提升性能
   - 流程：
     * Router 将消息写入 MQ-2
     * Store Service 批量消费消息
     * 写入 MongoDB 持久化存储
     * 构建消息索引和统计

3. MQ-3（离线通知队列）
   - 来源：Message Router 识别的离线消息
   - 去处：Notification Service 处理推送
   - 作用：异步推送，支持限流
   - 流程：
     * Router 将离线消息写入 MQ-3
     * Notification Service 消费消息
     * 生成推送通知
     * 通过推送通道发送给客户端

#### 3.2.5 关键节点说明

1. 消息发送（Client -> Gateway）
   - 客户端发起消息请求
   - 包含消息内容和元数据
   - 基础格式校验

2. 消息预处理（Gateway -> Router）
   - 消息解析和格式转换
   - 生成消息ID和时间戳
   - 初始化消息状态

3. 内容过滤（Router -> Filter）
   - 敏感词检测
   - 反垃圾过滤
   - 内容安全扫描

4. 权限校验（Router -> Services）
   - 好友关系验证
   - 群成员状态检查
   - 频率限制检查

5. 消息入队（Router -> MQ-1）
   - 写入实时消息队列
   - 确保消息可靠性
   - 返回确认响应

6. 会话处理（Router -> Session）
   - 查询在线状态
   - 更新会话信息
   - 路由表维护

7. 存储处理（MQ-2 -> Store）
   - 消息持久化
   - 索引构建
   - 历史记录归档

8. 消息投递（Router -> Gateway -> Client）
   - 在线消息推送
   - 送达确认
   - 状态同步

9. 离线处理（MQ-3 -> Notification）
   - 离线消息存储
   - 推送通知生成
   - 多端同步

#### 3.2.6 性能优化机制

1. 消息处理优化
   - 并行校验处理
   - 批量消息存储
   - 异步通知推送

2. 缓存优化
   - 路由表缓存
   - 会话状态缓存
   - 最近消息缓存

3. 存储优化
   - 分片存储
   - 冷热数据分离
   - 压缩存储

4. 推送优化
   - 实时推送优先
   - 批量推送合并
   - 动态推送频率

## 4. 可靠性保证机制

### 4.1 消息可靠性
1. ACK 确认机制：消息发送方收到接收方的确认后才认为发送成功
2. 消息重试机制：未收到 ACK 的消息会进行指数退避重试
3. 幂等性处理：通过消息 ID 去重，确保消息不会重复处理
4. 持久化保证：消息写入 Kafka 后再返回发送成功
5. 分布式事务：采用最终一致性确保消息状态同步

### 4.2 存储可靠性
1. 分片存储：
   - 按时间和会话 ID 进行分片
   - MongoDB 分片集群部署
   - 自动数据均衡分布

2. 冷热分离：
   - 热数据保存在 MongoDB 主集群
   - 冷数据迁移到归档集群
   - 按时间自动归档策略

3. 数据优化：
   - MongoDB 索引优化
   - 文档压缩存储
   - 支持快速检索和聚合
   - 支持 TTL 索引自动过期

4. 分级存储：
   - L0：Redis 缓存最近消息
   - L1：MongoDB 存储活跃消息（支持实时查询）
   - L2：MongoDB 归档集群存储历史消息

5. 高可用保证：
   - MongoDB 副本集部署
   - 自动故障转移
   - 数据多副本保证
   - 定期备份策略

6. 性能优化：
   - 索引覆盖查询
   - 复合索引设计
   - 文档结构优化
   - 批量写入优化
   - 读写分离策略

7. 监控和维护：
   - 性能指标监控
   - 容量规划
   - 定期索引维护
   - 数据均衡检查

## 5. 异步处理机制

### 5.1 消息存储异步化
- 消息先进入 Kafka 队列
- Store Service 异步消费并持久化
- 支持批量写入优化

### 5.2 通知服务异步化
- 离线消息进入通知队列
- Notification Service 异步处理推送
- 支持推送限流和重试

## 6. 服务依赖关系

### 6.1 核心依赖链
- Message Gateway -> Message Router
- Message Router -> Message Store
- Message Router -> Message Filter
- Message Router -> Session Service
- Message Store -> Kafka
- Session Service -> Redis
- Notification Service -> Redis

### 6.2 存储依赖
- 消息存储：ClickHouse
- 用户数据：PostgreSQL
- 媒体文件：MinIO
- 缓存数据：Redis Cluster
- 配置中心：etcd

## 7. 监控和运维

### 7.1 系统监控
- Prometheus：指标收集
- Grafana：监控可视化
- ELK Stack：日志分析
- Jaeger：分布式追踪

### 7.2 安全保障
- WAF：Web 应用防火墙
- DDoS 防护
- 数据加密传输
- 访问控制策略 

## 8. 消息系统详细设计

### 8.1 消息类型定义

#### 8.1.1 基础消息结构
```
Message {
    id: String,               // 消息唯一ID
    seq: i64,                // 消息序列号
    msg_type: i32,          // 消息类型
    content_type: i32,      // 内容类型
    content: String,        // 消息内容
    sender_id: String,      // 发送者ID
    send_time: i64,        // 发送时间
    status: i32,           // 消息状态
    options: MessageOptions // 消息选项
}

MessageOptions {
    need_push: bool,       // 是否需要推送
    push_title: String,    // 推送标题
    push_body: String,     // 推送内容
    push_sound: String,    // 推送声音
    retry_count: i32,      // 重试次数
    expire_time: i64,      // 过期时间
}
```

#### 8.1.2 消息类型分类

1. **单聊消息**
   ```
   SingleMessage extends Message {
       recv_id: String,     // 接收者ID
       read_time: i64,      // 已读时间
       recv_time: i64,      // 接收时间
   }
   ```

2. **群聊消息**
   ```
   GroupMessage extends Message {
       group_id: String,    // 群组ID
       at_users: Vec<String>, // @用户列表
       read_count: i32,     // 已读数
       unread_count: i32,   // 未读数
   }
   ```

3. **系统消息**
   ```
   SystemMessage extends Message {
       msg_level: i32,      // 消息级别
       target_type: i32,    // 目标类型(用户/群组)
       target_id: String,   // 目标ID
   }
   ```

### 8.2 消息操作流程

#### 8.2.1 单聊消息流程
```
┌──────────┐     ┌───────────┐     ┌──────────┐     ┌──────────┐
│ Sender   │     │ Router    │     │  Store   │     │ Receiver │
└────┬─────┘     └─────┬─────┘     └────┬─────┘     └────┬─────┘
     │                 │                 │                │
     │    发送消息     │                 │                │
     │─────────────────>                 │                │
     │                 │                 │                │
     │                 │    存储消息     │                │
     │                 │─────────────────>                │
     │                 │                 │                │
     │                 │   查询接收方     │                │
     │                 │─────────────────>                │
     │                 │                 │                │
     │                 │    消息投递     │                │
     │                 │────────────────────────────────> │
     │                 │                 │                │
     │                 │    已读回执     │                │
     │ <───────────────│─────────────────│ <──────────── │
     │                 │                 │                │
```

#### 8.2.2 群聊消息流程
```
┌──────────┐     ┌───────────┐     ┌──────────┐     ┌──────────┐
│ Sender   │     │ Router    │     │  Store   │     │ Members  │
└────┬─────┘     └─────┬─────┘     └────┬─────┘     └────┬─────┘
     │                 │                 │                │
     │    发送消息     │                 │                │
     │─────────────────>                 │                │
     │                 │                 │                │
     │                 │    存储消息     │                │
     │                 │─────────────────>                │
     │                 │                 │                │
     │                 │  查询群成员     │                │
     │                 │─────────────────>                │
     │                 │                 │                │
     │                 │    批量投递     │                │
     │                 │────────────────────────────────> │
     │                 │                 │                │
     │                 │    已读统计     │                │
     │ <───────────────│─────────────────│ <──────────── │
     │                 │                 │                │
```

### 8.3 消息操作类型

#### 8.3.1 基础操作
1. **发送消息**
   - 文本消息
   - 图片消息
   - 语音消息
   - 视频消息
   - 文件消息
   - 位置消息
   - 名片消息

2. **消息状态**
   - 发送中
   - 已发送
   - 已投递
   - 已读取
   - 已撤回
   - 已删除
   - 发送失败

#### 8.3.2 高级操作

1. **消息撤回**
```
┌──────────┐     ┌───────────┐     ┌──────────┐
│ Sender   │     │ Router    │     │ Receiver │
└────┬─────┘     └─────┬─────┘     └────┬─────┘
     │  撤回请求  │           │          │
     │───────────>│           │          │
     │           │ 权限验证   │          │
     │           │──────┐    │          │
     │           │      │    │          │
     │           │<─────┘    │          │
     │           │ 更新状态  │          │
     │           │───────────>          │
     │           │           │          │
     │           │ 撤回通知  │          │
     │           │─────────────────────>│
```

2. **消息编辑**
```
┌──────────┐     ┌───────────┐     ┌──────────┐
│ Sender   │     │ Router    │     │ Receiver │
└────┬─────┘     └─────┬─────┘     └────┬─────┘
     │  编辑请求  │           │          │
     │───────────>│           │          │
     │           │ 权限验证   │          │
     │           │──────┐    │          │
     │           │      │    │          │
     │           │<─────┘    │          │
     │           │ 更新内容  │          │
     │           │───────────>          │
     │           │           │          │
     │           │ 编辑通知  │          │
     │           │─────────────────────>│
```

3. **消息引用**
```
┌──────────┐     ┌───────────┐     ┌──────────┐
│ User A   │     │ Router    │     │ User B   │
└────┬─────┘     └─────┬─────┘     └────┬─────┘
     │ 引用消息  │           │          │
     │───────────>│           │          │
     │           │ 验证原消息 │          │
     │           │──────┐    │          │
     │           │      │    │          │
     │           │<─────┘    │          │
     │           │ 发送引用  │          │
     │           │─────────────────────>│
```

### 8.4 消息同步机制

#### 8.4.1 增量同步
```
┌──────────┐     ┌───────────┐     ┌──────────┐
│ Client   │     │ Sync      │     │  Store   │
└────┬─────┘     └─────┬─────┘     └────┬─────┘
     │ 同步请求  │           │          │
     │(last_seq) │           │          │
     │───────────>│           │          │
     │           │ 查询新消息 │          │
     │           │─────────────────────>│
     │           │           │          │
     │           │ 返回消息列表         │
     │           │<────────────────────│
     │           │           │          │
     │ 返回增量  │           │          │
     │<──────────│           │          │
```

#### 8.4.2 全量同步
```
┌──────────┐     ┌───────────┐     ┌──────────┐
│ Client   │     │ Sync      │     │  Store   │
└────┬─────┘     └─────┬─────┘     └────┬─────┘
     │ 全量请求  │           │          │
     │───────────>│           │          │
     │           │ 分页查询   │          │
     │           │─────────────────────>│
     │           │           │          │
     │           │ 返回分页数据         │
     │           │<────────────────────│
     │           │           │          │
     │ 返回数据包│           │          │
     │<──────────│           │          │
     │           │           │          │
     │ 确认接收  │           │          │
     │───────────>│           │          │
```

### 8.5 消息存储结构

#### 8.5.1 消息索引
```sql
CREATE TABLE message_index (
    msg_id String,      -- 消息ID
    seq Int64,          -- 序列号
    session_id String,  -- 会话ID
    msg_type Int32,     -- 消息类型
    sender_id String,   -- 发送者
    send_time DateTime, -- 发送时间
    status Int32,       -- 状态
    PRIMARY KEY (session_id, seq)
)
```

#### 8.5.2 消息内容
```sql
CREATE TABLE message_content (
    msg_id String,      -- 消息ID
    content_type Int32, -- 内容类型
    content String,     -- 内容
    extra String,       -- 扩展信息
    PRIMARY KEY (msg_id)
)
```

### 8.6 消息可靠性保证

#### 8.6.1 消息存储可靠性
1. **多副本存储**
   - 主从复制
   - 数据一致性校验
   - 自动故障转移

2. **消息持久化**
   - 写前日志(WAL)
   - 定期检查点
   - 崩溃恢复机制

#### 8.6.2 消息投递可靠性
1. **ACK机制**
   ```
   发送方 -> 存储层(ACK1) -> 路由层(ACK2) -> 接收方(ACK3)
   ```

2. **重试机制**
   ```
   retry_interval = base_interval * (2 ^ retry_count)
   max_retries = 3
   ```

3. **消息幂等性**
   ```
   message_key = hash(msg_id + session_id + seq)
   ``` 